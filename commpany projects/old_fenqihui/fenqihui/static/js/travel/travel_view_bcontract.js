"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}();controllerFunc("ngScope","ngController",function(e,t,r,a){var s=new Dialog(DIALOG_LOAD);e.imgSelect=!1,e.imgShow={display:"block"},e.imgHidden={display:"none"};var o=GetQueryString("oId"),n=GetQueryString("processStatus"),l=GetQueryString("isQianyue");e.sType=GetQueryString("pType"),e.isToDelete=!1,e.isToAdd=!1,e.deleteImgs=[],e.isShowRemove=!0,e.isShowRemoveTravel=!0,"303"==n&&(e.isShowRemoveTravel=!1),"304"==n&&(e.isShowRemove=!1);var i=function(){function r(){_classCallCheck(this,r);var t=[[],[],[]];e.travelImgs=t[0],e.receiptImgs=t[1],e.otherImgs=t[2];var a=[[],[],[]];e.travelImgs1=a[0],e.receiptImgs1=a[1],e.otherImgs1=a[2];var s=[[],[],[]];e.travelImgsPass=s[0],e.receiptImgsPass=s[1],e.otherImgsPass=s[2],e.images={localId:[],serverId:[],mediaId:[]},"旅游"==e.sType&&(e.otherData="签证资料"),e.serverIds=[],this.getContractImg()}return _createClass(r,[{key:"passToSever",value:function(r){t({method:"POST",url:BaseUrl+"contractInfo/addContractInfoForWx",params:{imageIds:r,token:getToken(),isQianyue:l,oId:o,source:"fqh"}}).then(function(t){if(t.data.result===SUCCESS_CODE){t.data.contractNum;e.passToServerNum++,alert("上传成功"),go_page("../travel/tracel_myStages.html",{signing:!1})}else alert("上传合同失败"),s.hide()},function(){alert("error"),s.hide()}),e.isToAdd=!1}},{key:"removeToServer",value:function(r){var a=this;e.isToDelete?t({method:"POST",url:BaseUrl+"contractInfo/delContract",params:{imgIds:r,token:getToken()}}).then(function(t){t.data.result===SUCCESS_CODE?(alert("修改合同成功"),e.isToAdd?a.mergeArr():go_page("../travel/tracel_myStages.html",{signing:!1})):(alert("修改合同失败"),e.isToAdd&&a.mergeArr())},function(){alert("error")}):e.isToAdd&&this.mergeArr()}},{key:"addTravelImg",value:function(t,r){wx.chooseImage({count:1,sizeType:["compressed"],sourceType:["camera"],success:function(a){e.$apply(function(){var s;if((s=e[t]).push.apply(s,_toConsumableArray(a.localIds)),"303"==n){var o;e.isToAdd=!0,(o=e.travelImgs1).push.apply(o,_toConsumableArray(a.localIds))}if("304"==n){if(2==r){var l;e.isToAdd=!0,(l=e.receiptImgs1).push.apply(l,_toConsumableArray(a.localIds))}if(3==r){var i;e.isToAdd=!0,(i=e.otherImgs1).push.apply(i,_toConsumableArray(a.localIds))}}if(6==e[t].length){var g=t+"Full";e[g]=!0}})}})}},{key:"uploadToWeChat",value:function(t){var r;t.length>0&&(r=t.pop().toString());var a=this;wx.uploadImage({localId:r,isShowProgressTips:0,success:function(r){e.serverIds.push(r.serverId),t.length>0?a.uploadToWeChat(t):a.serializeData()},fail:function(e){alert("上传到微信服务器失败"),alert(JSON.stringify(e)),s.hide()}})}},{key:"getContractImg",value:function(){var r=GetQueryString("conId");return r?void t({method:"POST",url:BaseUrl+"contractInfo/findConImgs",params:{token:getToken(),conId:r}}).then(function(t){if(t.data.result==SUCCESS_CODE){e.contracts=t.data.type1,e.travelLentgh=e.contracts.length;for(var r=0;r<e.travelLentgh;r++)e.travelImgs[r]=e.contracts[r].fileUrl,e.travelImgsPass[r]=e.contracts[r].imgId;e.payContract=t.data.type2,e.payLength=e.payContract.length;for(var a=0;a<e.payLength;a++)e.receiptImgs[a]=e.payContract[a].fileUrl,e.receiptImgsPass[a]=e.payContract[a].imgId;e.otherContract=t.data.type3,e.otherLength=e.otherContract.length;for(var s=0;s<e.otherLength;s++)e.otherImgs[s]=e.otherContract[s].fileUrl,e.otherImgsPass[s]=e.otherContract[s].imgId}else t.data.result==ERROR_CODE&&console.log("失败数据请求！")},function(){console.log("网络异常！")}):!1}},{key:"downLoadImg",value:function(){function t(){wx.downloadImage({serverId:e.images.serverId[r],success:function(s){r++,e.images.mediaId.push(s.localId),alert("下载成功"),a>r&&t()}})}if(0===e.images.serverId.length)return void alert("请先使用 uploadImage 上传图片");var r=0,a=e.images.serverId.length;e.images.mediaId=[],t()}},{key:"verify",value:function(){return e.travelImgs.length>=0&&e.travelImgs.length<7&&e.receiptImgs.length>=0&&e.receiptImgs.length<7&&e.otherImgs.length<10}},{key:"submitContract",value:function(){var t=this;return e.travelImgs.length+e.otherImgs.length+e.otherImgs.length==0?(alert("请上传拍摄图片"),!1):void(this.verify()&&function(){return t.removeToServer(e.deleteImgs),!0}())}},{key:"removeImg",value:function(t,r,a){e.isToDelete=!0;var s;if(s=e.travelImgs[r].indexOf("http"),e[t].splice(r,1),0==s)303==n?e.travelImgsPass[r]&&(e.deleteImgs.push(e.travelImgsPass[r]),e.travelImgsPass.splice(r,1),e.isToDelete=!0):2==a?e.receiptImgsPass[r]&&(e.deleteImgs.push(e.receiptImgsPass[r]),e.receiptImgsPass.splice(r,1),e.isToDelete=!0):e.otherImgsPass[r]&&(e.deleteImgs.push(e.otherImgsPass[r]),e.otherImgsPass.splice(r,1),e.isToDelete=!0);else{if("303"==n){var o=e.travelImgs1.length-1-(e[t].length-r);e.travelImgs1.splice(o,1)}0==e.deleteImgs.length&&(e.isToDelete=!1)}var l=t+"Full";e[l]=!1}},{key:"mergeArr",value:function(){"303"==n&&(e.allImgsArr=e.travelImgs1),"304"==n&&(e.allImgsArr=[].concat(_toConsumableArray(e.receiptImgs1),_toConsumableArray(e.otherImgs1))),e.travelLen=e.travelImgs1.length,e.receiptLen=e.receiptImgs1.length,e.otherImgsLen=e.otherImgs1.length,e.travelLen+e.receiptLen+e.otherImgsLen==0?e.isToAdd=!1:e.isToAdd=!0,e.isToAdd&&(s.show(),this.uploadToWeChat(e.allImgsArr))}},{key:"serializeData",value:function(){for(var t=[],r=0,a=e.serverIds.length;a>r;r++){var s={imageId:e.serverIds[r]};"303"==n?s.subType="1":"304"==n&&(r<e.receiptLen?s.subType="3":s.subType="2"),t.push(s)}this.passToSever(JSON.stringify(t))}}]),r}(),g=new i;e.addTravelImg=function(e){"303"==n&&g.addTravelImg(e)},e.addTravelImg2=function(e,t){"304"==n&&g.addTravelImg(e,t)},e.submitContract=function(){g.submitContract()},e.removeImg=function(e,t){"303"==n&&g.removeImg(e,t)},e.scaleImg=function(t,r){e.imgSelect=!0,e.imgUrl=$(t.target).attr("src")},e.shelterHidden=function(){e.imgSelect=!1,e.tit="查看旅行合同"}});